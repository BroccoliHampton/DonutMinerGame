<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Pinky Glazers „ÉÑ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js" type="application/javascript"></script>
    <style>
        /* [KEEPING ALL THE ORIGINAL STYLES - NO CHANGES] */
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Luckiest+Guy&display=swap');
        
        body {
            font-family: 'Nunito', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overscroll-behavior: none;
            background-color: #FFC0CB;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cg opacity='0.7'%3E%3Crect x='10' y='10' width='3' height='10' fill='%23FFD700' transform='rotate(25 11.5 15)' /%3E%3Crect x='60' y='30' width='3' height='10' fill='%23FF69B4' transform='rotate(140 61.5 35)' /%3Crect x='30' y='70' width='3' height='10' fill='%2390EE90' transform='rotate(70 31.5 75)' /%3Crect x='80' y='85' width='3' height='10' fill='%2387CEEB' transform='rotate(210 81.5 90)' /%E3%80%89%3Crect x='5' y='45' width='3' height='10' fill='%23FFD700' transform='rotate(100 6.5 50)' /%3E%3Crect x='90' y='5' width='3' height='10' fill='%23FF69B4' transform='rotate(300 91.5 10)' /%3E%3C/g%3E%3C/svg%3E"), 
                            linear-gradient(135deg, #FFC0CB 0%, #FFDDE1 100%);
            background-size: 200px 200px, cover;
            background-blend-mode: overlay, normal;
            background-attachment: fixed;
            color: #333333;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 0;
            margin: 0;
        }

        .bg-tamagotchi-bg-light { background-color: #FFFACD; } 
        .text-tamagotchi-dark { color: #333333; }
        .text-tamagotchi-pink-dark { color: #E75480; }
        .text-tamagotchi-pink-light { color: #FF9AA2; }
        
        .bg-tamagotchi-button-pink { 
            background: linear-gradient(to bottom, #FFDDE1, #E75480);
            color: white;
            font-weight: 800;
            border: 2px solid #C04A70;
        }
        .bg-tamagotchi-button-teal { 
            background: linear-gradient(to bottom, #B3F0E6, #66CCBF);
            color: white;
            font-weight: 800;
            border: 2px solid #50A89C;
        }
        .bg-tamagotchi-button-pink:active, .bg-tamagotchi-button-teal:active {
            transform: translateY(1px);
            box-shadow: none;
        }

        .border-tamagotchi-subtle { border-color: #E0E0E0; }
        .bg-tamagotchi-card { 
            background-color: #FFFACD;
            border: 2px solid #E0E0E0;
        }
        .border-tamagotchi-accent-pink { border-color: #FF9AA2; }

        .rounded-tamagotchi-lg { border-radius: 20px; }
        .rounded-tamagotchi-md { border-radius: 14px; }
        .rounded-tamagotchi-full { border-radius: 9999px; }

        .shadow-tamagotchi { box-shadow: 0px 6px 15px rgba(0, 0, 0, 0.1); }
        
        .nav-icon span {
            font-size: 32px;
            color: #A0A0A0;
            transition: color 0.2s ease-in-out, transform 0.2s ease-in-out;
        }
        .nav-icon.active span {
            color: #E75480;
            transform: scale(1.1);
        }

        #cookie-canvas {
            width: 100%;
            height: 100%;
            max-width: 400px;
            max-height: 400px;
            cursor: grab;
            touch-action: none;
            position: relative;
            z-index: 20;
            margin: auto;
        }
        #cookie-canvas:active {
            cursor: grabbing;
        }

        .color-cycle-button {
            position: absolute;
            bottom: 10px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid #E0E0E0;
            background-color: #f0f0f0;
            box-shadow: 0px 2px 5px rgba(0,0,0,0.2);
            transition: transform 0.1s ease-in-out, background-color 0.2s;
            z-index: 30;
        }
        .color-cycle-button:active {
            transform: translateY(1px);
            box-shadow: none;
        }
        #glaze-color-button {
            right: 8px;
        }
        #sprinkle-color-button {
            right: 48px;
        }
        #donut-base-color-button {
            right: 88px;
        }

        /* NEW: Toggle button positioning */
        #view-toggle-button {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid #C04A70;
            background: linear-gradient(to bottom, #FFDDE1, #E75480);
            color: white;
            box-shadow: 0px 4px 8px rgba(0,0,0,0.2);
            transition: transform 0.1s ease-in-out, opacity 0.2s;
            z-index: 30;
            font-weight: bold;
        }
        #view-toggle-button:active {
            transform: translateY(1px);
            box-shadow: none;
        }
        /* Style for the two containers below the donut */
        .glaze-blaze-container {
            min-height: 100px; /* Adjust based on content height to prevent jump */
            transition: opacity 0.3s ease;
        }

        .glitch-static {
            position: relative;
            overflow: hidden;
            background-color: #FFFACD !important;
        }

        .glitch-static::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                linear-gradient(rgba(240, 230, 200, 0.4) 1px, transparent 1px),
                linear-gradient(90deg, rgba(240, 230, 200, 0.4) 1px, transparent 1px);
            background-size: 4px 4px;
            animation: static-flicker 0.5s infinite alternate, static-move 3s steps(10) infinite;
            opacity: 0.6;
            pointer-events: none;
            z-index: 15;
        }

        .glitch-static::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                to bottom,
                transparent 0%,
                rgba(240, 230, 200, 0.2) 50%,
                transparent 100%
            );
            mix-blend-mode: overlay;
            animation: scanline 8s linear infinite;
            opacity: 0.3;
            pointer-events: none;
            z-index: 16;
        }

        @keyframes static-flicker {
            0% { background-position: 0 0; opacity: 0.6; }
            50% { background-position: 8px 8px; opacity: 0.5; }
            100% { background-position: 0 0; opacity: 0.7; }
        }

        @keyframes static-move {
            0% { transform: translate(0, 0); }
            100% { transform: translate(0, 100%); }
        }

        @keyframes scanline {
            0% { background-position: 0 0; }
            100% { transform: translate(0, 100%); }
        }

        .falling-snow {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 17;
            overflow: hidden;
        }

        .falling-snow::before,
        .falling-snow::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 10% 20%, #A0A0A0 1px, transparent 1px),
                radial-gradient(circle at 70% 80%, #C0C0C0 1px, transparent 1px),
                radial-gradient(circle at 30% 60%, #B0B0B0 1px, transparent 1px),
                radial-gradient(circle at 90% 10%, #E0E0E0 1px, transparent 1px),
                radial-gradient(circle at 50% 40%, #D0D0D0 1px, transparent 1px),
                radial-gradient(circle at 20% 90%, #F0F0F0 1px, transparent 1px),
                radial-gradient(circle at 80% 30%, #A0A0A0 1px, transparent 1px),
                radial-gradient(circle at 40% 70%, #C0C0C0 1px, transparent 1px),
                radial-gradient(circle at 60% 5%, #B0B0B0 1px, transparent 1px),
                radial-gradient(circle at 5% 50%, #E0E0E0 1px, transparent 1px),
                radial-gradient(circle at 95% 45%, #D0D0D0 1px, transparent 1px);
            background-repeat: repeat;
            background-size: 20px 20px;
            animation: snowfall 10s linear infinite;
            opacity: 0.7;
        }

        .falling-snow::after {
            animation-delay: 5s;
            background-size: 25px 25px;
            opacity: 0.6;
            filter: blur(0.5px);
        }

        @keyframes snowfall {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100%); }
        }

        .ticker-wrap {
            width: 100%;
            overflow: hidden;
            background-color: #333;
            padding: 4px 0;
            border-top: 2px solid #555;
            border-bottom: 2px solid #555;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }
        
        #top-ticker { margin-bottom: 8px; }
        #bottom-ticker { margin-top: 8px; }

        .ticker-move {
            display: inline-block;
            white-space: nowrap;
            animation: scroll-ticker 20s linear infinite;
            color: #FFFACD;
            font-size: 14px;
            font-weight: bold;
            font-family: 'Comic Neue', cursive;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.5);
        }

        .ticker-move-reverse {
            display: inline-block;
            white-space: nowrap;
            animation: scroll-ticker-reverse 20s linear infinite;
            color: #FFFACD;
            font-size: 14px;
            font-weight: bold;
            font-family: 'Comic Neue', cursive;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.5);
        }

        @keyframes scroll-ticker-reverse {
            0% { transform: translateX(-50%); }
            100% { transform: translateX(0%); }
        }
        
        body.dark {
            background-color: #5C3317;
            background-image: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%236B4A34' fill-opacity='0.4'%3E%3Cpath d='M10 0L0 10l10 10 10-10z'/%3E%3Cpath d='M0 10L10 20l10-10L10 0z'/%3E%3C/g%3E%3C/svg%3E"), 
                            linear-gradient(135deg, #5C3317 0%, #3D2B1F 100%);
        }

        body.dark .bg-tamagotchi-card {
            background-color: #3D2B1F;
            border-color: #4A3A2A;
        }
        
        body.dark .text-tamagotchi-dark { color: #F5E6C1; }
        body.dark .text-gray-500 { color: #A8998A; }
        body.dark .text-gray-600 { color: #B8A99A; }
        
        body.dark .text-tamagotchi-pink-dark { color: #FF9AA2; }

        body.dark .glitch-static {
            background-color: #3D2B1F !important;
        }
        body.dark .glitch-static::before {
            background: 
                linear-gradient(rgba(150, 130, 110, 0.4) 1px, transparent 1px),
                linear-gradient(90deg, rgba(150, 130, 110, 0.4) 1px, transparent 1px);
        }
        body.dark .glitch-static::after {
            background: linear-gradient(
                to bottom,
                transparent 0%,
                rgba(150, 130, 110, 0.2) 50%,
                transparent 100%
            );
        }
        
        body.dark .falling-snow::before {
            opacity: 0.4;
        }
        body.dark .falling-snow::after {
            opacity: 0.3;
        }

        body.dark .border-tamagotchi-subtle { border-color: #4A3A2A; }
        
        body.dark .nav-icon span {
            color: #A8998A;
        }
        body.dark .nav-icon.active span {
            color: #FF9AA2;
        }
        
        body.dark .color-cycle-button {
            background-color: #3D2B1F;
            border-color: #4A3A2A;
            color: #F5E6C1;
        }
        
        body.dark .bg-tamagotchi-bg-light {
            background-color: #3D2B1F;
        }

        .zoom-slider {
            position: absolute;
            top: 50%;
            right: 8px;
            transform: translateY(-50%);
            width: 16px;
            height: 100px;
            -webkit-appearance: none;
            appearance: none;
            writing-mode: vertical-lr;
            direction: ltr;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            z-index: 30;
            padding: 0;
            transition: background 0.2s;
        }
        body.dark .zoom-slider {
            background: rgba(255, 255, 255, 0.2);
        }

        .zoom-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 22px;
            height: 22px;
            background: #FFFACD;
            border-radius: 50%;
            border: 2px solid #E75480;
            cursor: grab;
        }
        .zoom-slider::-moz-range-thumb {
            width: 22px;
            height: 22px;
            background: #FFFACD;
            border-radius: 50%;
            border: 2px solid #E75480;
            cursor: grab;
        }
        body.dark .zoom-slider::-webkit-slider-thumb {
            background: #3D2B1F;
            border-color: #FF9AA2;
        }
        body.dark .zoom-slider::-moz-range-thumb {
            background: #3D2B1F;
            border-color: #FF9AA2;
        }
    </style>
</head>
<body class="text-tamagotchi-dark">
        
    <main class="flex-grow flex flex-col px-3 pt-4 pb-1 max-w-lg mx-auto w-full"> 
        <div class="flex justify-between items-center mb-2">
            <div class="flex flex-col">
                <h1 class="text-3xl font-black text-tamagotchi-pink-dark" style="font-family: 'Luckiest Guy', cursive;">Pinky Glazers</h1>
                
                <div class="bg-tamagotchi-card rounded-tamagotchi-lg shadow-tamagotchi p-2 flex items-center space-x-3 mt-1">
                    <div>
                        <div id="player-profile-name" class="font-extrabold text-sm truncate text-tamagotchi-dark">Loading...</div>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-1 self-start">
                <button id="dark-mode-toggle-button" class="bg-tamagotchi-button-teal text-white text-base w-8 h-8 flex items-center justify-center rounded-tamagotchi-md shadow-tamagotchi active:opacity-80">üåô
                </button>
                <button id="info-button" class="bg-tamagotchi-button-pink text-white text-base w-8 h-8 flex items-center justify-center rounded-tamagotchi-md shadow-tamagotchi active:opacity-80">‚ùì
                </button>
                <button id="music-toggle-button" class="bg-tamagotchi-button-pink text-white text-base w-8 h-8 flex items-center justify-center rounded-tamagotchi-md shadow-tamagotchi active:opacity-80">üîá
                </button>
                <button id="sfx-toggle-button" class="bg-tamagotchi-button-teal text-white text-base w-8 h-8 flex items-center justify-center rounded-tamagotchi-md shadow-tamagotchi active:opacity-80">üîä
                </button>
            </div>
        </div>

        <div id="view-glazery" class="flex-grow flex flex-col">
            <div class="bg-tamagotchi-card rounded-tamagotchi-lg shadow-tamagotchi p-2 grid grid-cols-3 gap-2">
                <div class="text-center">
                    <div class="text-xs text-gray-500 font-semibold">King Glazer</div>
                    <div id="bakery-king-status" class="font-extrabold text-sm truncate text-tamagotchi-dark">Loading...</div>
                </div>
                <div class="text-center">
                    <div class="text-xs text-gray-500 font-semibold">Glazed</div>
                    <div class="font-extrabold text-sm text-tamagotchi-dark">üç© <span id="bakery-cps">0.00</span></div>
                </div>
                <div class="text-center">
                    <div class="text-xs text-gray-500 font-semibold">Glaze Time</div>
                    <div class="font-extrabold text-sm text-tamagotchi-dark"><span id="bakery-baked">00:00:00</span></div>
                </div>
            </div>

            <div id="top-ticker" class="ticker-wrap" style="margin-bottom: 4px; margin-top: 8px;">
                <div class="ticker-move">
                    <span>Glaze price doubles each time a new Glazer takes over, and price cools down to $0 over 1 hour. ... Glaze price doubles each time a new Glazer takes over, and price cools down to $0 over 1 hour. ... </span>
                </div>
            </div>

            <div id="cookie-rain-container" class="relative h-56 flex items-center justify-center overflow-hidden bg-tamagotchi-card rounded-tamagotchi-lg shadow-tamagotchi glitch-static">
                <div class="falling-snow"></div>
                <canvas id="cookie-canvas"></canvas>
                <button id="view-toggle-button" class="shadow-tamagotchi">üßä</button>
                <button id="glaze-color-button" class="color-cycle-button shadow-tamagotchi bg-white text-tamagotchi-dark">üé®</button>
                <button id="sprinkle-color-button" class="color-cycle-button shadow-tamagotchi bg-white text-tamagotchi-dark">üåà</button>
                <button id="donut-base-color-button" class="color-cycle-button shadow-tamagotchi bg-white text-tamagotchi-dark">üç©</button>
                <input id="glazery-zoom-slider" type="range" class="zoom-slider">
            </div>

            <div id="bottom-ticker" class="ticker-wrap" style="margin-top: 4px;">
                <div class="ticker-move-reverse">
                    <span>Glaze price doubles each time a new Glazer takes over, and price cools down to $0 over 1 hour. ... Glaze price doubles each time a new Glazer takes over, and price cools down to $0 over 1 hour. ... </span>
                </div>
            </div>
            
            <div id="glaze-blaze-wrapper" class="glaze-blaze-container flex flex-col justify-start"> 
                
                <div id="glaze-container">
                    <div class="bg-tamagotchi-card text-tamagotchi-dark p-2 rounded-tamagotchi-lg shadow-tamagotchi">
                        <div class="flex justify-between items-center">
                            <div>
                                <div class="text-xs font-semibold text-gray-600">Glaze Price</div>
                                <div id="glaze-price-display" class="text-xl font-extrabold text-tamagotchi-dark">$0.00</div>
                                <div id="available-balance-display" class="text-xs text-gray-500">$0.00 available</div>
                            </div>
                            
                            <div class="flex flex-col items-end">
                                <button id="bakery-action-button" class="bg-tamagotchi-button-pink text-white py-2 px-6 rounded-tamagotchi-md text-sm font-bold active:opacity-80 disabled:opacity-50 shadow-tamagotchi">
                                    Glaze
                                </button>
                                <div class="text-right mt-1"> 
                                    <div class="text-xs font-semibold text-gray-600">Donuts/s</div>
                                    <div id="glaze-dps-display" class="text-sm font-extrabold text-tamagotchi-dark">0.00</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="blaze-container" class="hidden"> 
                    <div class="bg-tamagotchi-card text-tamagotchi-dark p-2 rounded-tamagotchi-lg shadow-tamagotchi">
                        <div class="flex justify-between items-center">
                            <div>
                                <div class="text-xs font-semibold text-gray-600">Blaze Price (LP)</div>
                                <div id="blaze-price-display" class="text-xl font-extrabold text-tamagotchi-dark">0.00</div>
                                <div id="blaze-available-balance-display" class="text-xs text-gray-500">0.00 LP available</div>
                            </div>
                            
                            <div class="flex flex-col items-end">
                                <button id="blaze-action-button" class="bg-tamagotchi-button-teal text-white py-2 px-6 rounded-tamagotchi-md text-sm font-bold active:opacity-80 disabled:opacity-50 shadow-tamagotchi">
                                    Blaze
                                </button>
                                <div class="text-right mt-1">
                                    <div class="text-xs font-semibold text-gray-600">Claim</div>
                                    <div id="blaze-claim-amount" class="text-sm font-extrabold text-tamagotchi-dark">0.00 ETH</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-tamagotchi-card rounded-tamagotchi-lg shadow-tamagotchi p-2 grid grid-cols-3 gap-2 mt-2">
                <div class="text-center">
                    <div class="text-xs text-gray-500 font-semibold">Donut Balance</div>
                    <div id="player-donut-balance" class="font-extrabold text-sm truncate text-tamagotchi-dark">üç© 0</div>
                </div>
                <div class="text-center">
                    <div class="text-xs text-gray-500 font-semibold">Total Supply</div>
                    <div id="total-supply-display" class="font-extrabold text-sm text-tamagotchi-dark">üç© 0</div>
                </div>
                <div class="text-center">
                    <div class="text-xs text-gray-500 font-semibold">DPS</div>
                    <div id="current-dps-display" class="font-extrabold text-sm text-tamagotchi-dark">0</div>
                </div>
            </div>

        </div>
    </main>

    <div id="info-modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>
    <div id="info-modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-tamagotchi-card rounded-tamagotchi-lg shadow-tamagotchi p-4 z-50 hidden w-11/12 max-w-xs text-tamagotchi-dark overflow-y-auto" style="max-height: 90vh;">
        <div class="flex justify-between items-center mb-2">
            <h3 class="text-xl font-bold text-tamagotchi-pink-dark">Info</h3>
            <button id="info-modal-close" class="text-2xl font-bold text-gray-500 hover:text-tamagotchi-pink-dark">&times;</button>
        </div>
        <div class="space-y-3">
            <div class="bg-tamagotchi-card rounded-tamagotchi-lg shadow-tamagotchi p-4 space-y-4 text-tamagotchi-dark">
                <p class="font-bold text-lg" style="font-family: 'Comic Neue', cursive;">
                    Hello and welcome to Pinky Glazers!
                </p>
                <p class="text-sm">
                    Pay the Glaze Price to become <strong>King Glazer</strong> and earn <strong>100%</strong> of the $DONUT emissions until you are replaced.
                </p>
                <p class="text-sm">
                    Glaze price doubles each time a new Glazer takes over, and price cools down to $0 over 1 hour.
                </p>
            </div>
            <h3 class="text-xl font-bold text-tamagotchi-pink-dark pt-2">Global Donut Stats</h3>
            <div class="bg-tamagotchi-card rounded-tamagotchi-lg shadow-tamagotchi p-4 space-y-3 text-tamagotchi-dark">
                <div class="flex justify-between items-center">
                    <span class="text-sm font-semibold text-gray-600">Total Donut Supply</span>
                    <span id="modal-total-supply" class="font-extrabold text-tamagotchi-dark">üç© 0</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm font-semibold text-gray-600">Time Until Halving</span>
                    <span id="modal-next-halving" class="font-extrabold text-tamagotchi-dark">--:--:--</span>
                </div>
                <div class="flex justify-between items-center">
                    <span id="modal-current-miner-label" class="text-sm font-semibold text-gray-600">Current Miner</span>
                    <span id="modal-current-miner" class="font-extrabold text-tamagotchi-dark text-xs">None</span>
                </div>
            </div>
        </div>
    </div>

<script>
        // =============================================================
        // GLOBAL FUNCTIONS (Defined before DOMContentLoaded runs)
        // =============================================================

        // CRITICAL: We need a placeholder for DOM elements since they are only defined inside DOMContentLoaded
        // We ensure that internal functions (like sendTxWithRetry) are available globally.
        // The main fetching and handling functions are defined globally for reliable access.
        
        // TRANSACTION RETRY HELPER (Copied from DOMContentLoaded for global access)
        async function sendTxWithRetry(provider, txParams, maxAttempts = 3, delay = 500) {
            for (let i = 0; i < maxAttempts; i++) {
                try {
                    if (i > 0) {
                        console.log(`[Blockchain] Retrying transaction... Attempt ${i + 1}/${maxAttempts}`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                    
                    const txHash = await provider.request({
                        method: 'eth_sendTransaction',
                        params: txParams
                    });
                    
                    return txHash; // Success! Return hash.

                } catch (error) {
                    const isRetryable = error.message.includes('timeout') || error.message.includes('Queue is full') || error.message.includes('JSON RPC');
                    if (!isRetryable || i === maxAttempts - 1) {
                        console.error('[Blockchain] Transaction failed permanently or non-retryable error:', error.message);
                        console.log(`Transaction failed: ${error.message}`); 
                        throw error;
                    }
                }
            }
        }
        
        // GLOBAL FUNCTION PLACEHOLDERS (Will be fully defined later, but needed for internal calls)
        let handleBlazeClick;
        let updateBlazeryUI;
        let fetchGameState;

        // ORIGINAL ASYNC APPROVAL FLOW (Simplified and corrected to remove Ethers dependency, restoring old logic)
        async function sendApprovalTransaction(address) {
            try {
                console.log('[Blaze] Fetching approval transaction data...');
                
                const approvalResponse = await fetch(`${API_BASE_URL}/api/approve-lp?player=${address}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' },
                    mode: 'cors'
                });
                
                if (!approvalResponse.ok) {
                    throw new Error(`Failed to get approval data: ${approvalResponse.status}`);
                }
                
                const txData = await approvalResponse.json();
                console.log('[Blaze] Approval transaction data received:', txData);
                
                const provider = await FarcasterSDK.wallet.getEthereumProvider();
                
                if (!provider) {
                    throw new Error('Wallet provider not available');
                }
                
                console.log('[Blaze] Sending approval transaction...');
                
                const txParams = [{
                    from: address,
                    to: txData.params.to,
                    data: txData.params.data,
                    value: txData.params.value || '0x0',
                }];
                
                const txHash = await sendTxWithRetry(provider, txParams);
                
                console.log('[Blaze] Approval transaction sent, TX Hash:', txHash);
                
                // --- RESTORING ORIGINAL LOGIC ---
                // 1. Optimistically update the UI (as in your old code)
                blockchainData.blaze.userNeedsApproval = false;
                updateBlazeryUI();
                
                // 2. Wait a few seconds, then force a state refresh. 
                // This relies on the background auto-refresh interval (10s) to eventually catch the confirmed state.
                console.log('[Blaze] Approval submitted. Waiting for auto-refresh to update state...');

                // We DO NOT manually call handleBlazeClick() here. 
                // The user must click the now-available 'Blaze' button, OR the next auto-refresh 
                // *might* catch the state change and the user can then click 'Blaze'.
                
            } catch (error) {
                console.error('[Blaze] Approval error:', error);
                console.log(`Approval failed: ${error.message}`);
                // Ensure the button reverts to 'Approve LP' if the transaction sending failed
                blockchainData.blaze.userNeedsApproval = true; 
                updateBlazeryUI();
            }
        }

        // =================================================================
        // DOM CONTENT LOADED (Main execution block)
        // =================================================================
        document.addEventListener('DOMContentLoaded', async () => {
            
            // --- CONSTANTS AND STATE DEFINITIONS ---
            const API_BASE_URL = 'https://last-game-kappa.vercel.app';
            const REFRESH_INTERVAL = 10000; 
            
            const MULTICALL_ADDRESS = '0xe03a89eb8b75d73Caf762a81dA260106fD42F18A';
            const LP_TOKEN_ADDRESS = '0xc3b9bd6f7d4bfcc22696a7bc1cc83948a33d7fab';

            // Initializing complex global objects here
            // Note: These need to be accessible by the global functions defined above, 
            // so they are usually defined outside or passed as arguments.
            
            // Ethers is already globally defined via the script tag in the header.

            // 1. Initialize Farcaster SDK before anything else
            await initSDK(); 

            // =============================================================
            // UI STATE (Non-blockchain)
            // =============================================================
            
            const state = {
                ui: {
                    isDarkMode: false,
                    isSfxMuted: false,
                    isGlazeView: true, 
                }
            };

            // =============================================================
            // DOM ELEMENTS (Accessors)
            // =============================================================
            const dom = {
                glazery: {
                    kingStatus: document.getElementById('bakery-king-status'),
                    cps: document.getElementById('bakery-cps'),
                    baked: document.getElementById('bakery-baked'),
                    actionButton: document.getElementById('bakery-action-button'),
                    canvas: document.getElementById('cookie-canvas'),
                    rainContainer: document.getElementById('cookie-rain-container'),
                    glazeColorButton: document.getElementById('glaze-color-button'),
                    sprinkleColorButton: document.getElementById('sprinkle-color-button'),
                    donutBaseColorButton: document.getElementById('donut-base-color-button'),
                    zoomSlider: document.getElementById('glazery-zoom-slider'),
                    donutBalance: document.getElementById('player-donut-balance'),
                    glazePrice: document.getElementById('glaze-price-display'),
                    availableBalance: document.getElementById('available-balance-display'),
                    totalSupply: document.getElementById('total-supply-display'),
                    currentDps: document.getElementById('current-dps-display'),
                    
                    toggleButton: document.getElementById('view-toggle-button'), 
                    glazeContainer: document.getElementById('glaze-container'), 
                    blazeContainer: document.getElementById('blaze-container'), 
                    
                    glazeDpsDisplay: document.getElementById('glaze-dps-display'), 

                    blazePrice: document.getElementById('blaze-price-display'),
                    blazeAvailableBalance: document.getElementById('blaze-available-balance-display'),
                    blazeActionButton: document.getElementById('blaze-action-button'),
                    blazeClaimAmount: document.getElementById('blaze-claim-amount'), 
                },
                profileName: document.getElementById('player-profile-name'),
                musicToggleButton: document.getElementById('music-toggle-button'),
                sfxToggleButton: document.getElementById('sfx-toggle-button'),
                darkModeToggleButton: document.getElementById('dark-mode-toggle-button'),
                infoButton: document.getElementById('info-button'),
                infoModal: document.getElementById('info-modal'),
                infoModalOverlay: document.getElementById('info-modal-overlay'),
                infoModalClose: document.getElementById('info-modal-close'),
                modalInfo: {
                    totalSupply: document.getElementById('modal-total-supply'),
                    nextHalving: document.getElementById('modal-next-halving'),
                    currentMiner: document.getElementById('modal-current-miner'),
                }
            };
            
            // =============================================================
            // BLOCKCHAIN FUNCTIONS (Re-defined/assigned for local scope access)
            // =============================================================

            // Assign global fetchGameState for internal calls to reference the DOM
            fetchGameState = async (userAddress = null) => {
                try {
                    const url = userAddress 
                        ? `${API_BASE_URL}/api/get-game-state?userAddress=${userAddress}`
                        : `${API_BASE_URL}/api/get-game-state`;
                    
                    console.log('[Blockchain] Fetching:', url);
                    
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' },
                        mode: 'cors'
                    });
                    
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    
                    const data = await response.json();
                    console.log('[Blockchain] Data received:', data);
                    
                    blockchainData = { ...blockchainData, ...data };
                    
                    if (data.blaze) {
                        blockchainData.blaze = {
                            epochId: data.blaze.epochId,
                            price: data.blaze.price,
                            priceFormatted: data.blaze.priceFormatted,
                            wethAccumulated: data.blaze.wethAccumulated,
                            wethAccumulatedFormatted: data.blaze.wethAccumulatedFormatted,
                            wethBalance: data.blaze.wethBalance,
                            wethBalanceFormatted: data.blaze.wethBalanceFormatted,
                            userLpBalance: data.blaze.userLpBalance,
                            userLpBalanceFormatted: data.blaze.userLpBalanceFormatted,
                            paymentToken: data.blaze.paymentToken,
                            paymentTokenPrice: data.blaze.paymentTokenPrice,
                            paymentTokenPriceFormatted: data.blaze.paymentTokenPriceFormatted,
                            userNeedsApproval: data.blaze.userNeedsApproval !== undefined ? data.blaze.userNeedsApproval : true
                        };
                        console.log('[Blockchain] Blaze data loaded:', blockchainData.blaze);
                        console.log('[Blockchain] *** userNeedsApproval:', blockchainData.blaze.userNeedsApproval);
                        console.log('[Blockchain] *** wethAccumulated (claimable):', blockchainData.blaze.wethAccumulatedFormatted);
                    }
                    
                    try {
                        updateUI();
                        updateBlazeryUI(); 
                    } catch (renderError) {
                        console.error('[Rendering Error] Failed to update UI after fetch (WASM crash likely):', renderError.message);
                        return;
                    }
                    
                    return data;
                } catch (error) {
                    console.error('[Blockchain] Fetch error:', error);
                    return null;
                }
            };
            
            // Assign global updateBlazeryUI for internal calls
            updateBlazeryUI = () => {
                if (!blockchainData.blaze || !dom.glazery.blazeActionButton) {
                    return;
                }
                
                console.log('[Blaze] Updating UI');
                
                const userNeedsApproval = blockchainData.blaze.userNeedsApproval;
                const blazeButton = dom.glazery.blazeActionButton;
                
                if (dom.glazery.blazePrice) {
                    const lpAmount = parseFloat(blockchainData.blaze.priceFormatted);
                    dom.glazery.blazePrice.textContent = lpAmount.toFixed(4);
                }
                
                if (dom.glazery.blazeClaimAmount) {
                    const ethAmount = parseFloat(blockchainData.blaze.wethAccumulatedFormatted);
                    dom.glazery.blazeClaimAmount.textContent = `${ethAmount.toFixed(6)} ETH`; 
                }
                
                if (dom.glazery.blazeAvailableBalance) {
                    const userLpBalance = parseFloat(blockchainData.blaze.userLpBalanceFormatted);
                    dom.glazery.blazeAvailableBalance.textContent = `${userLpBalance.toFixed(4)} LP available`;
                }
                
                // CRITICAL BUTTON LOGIC: If approval is needed, show "Approve LP"
                if (userNeedsApproval) {
                    blazeButton.textContent = 'Approve LP';
                    blazeButton.disabled = false;
                } else {
                    const lpBalance = parseFloat(blockchainData.blaze.userLpBalanceFormatted);
                    const lpNeeded = parseFloat(blockchainData.blaze.priceFormatted);
                    
                    blazeButton.textContent = 'Blaze';
                    blazeButton.disabled = lpBalance < lpNeeded;
                }
                
                console.log('[Blaze] UI updated successfully');
            };
            
            // Assign global handleBlazeClick for internal calls
            handleBlazeClick = async () => {
                console.log('[Blaze] Blaze button clicked');
                
                try {
                    if (!FarcasterSDK) throw new Error("SDK not initialized.");
                    
                    const address = blockchainData.userAddress;
                    
                    if (!address) {
                        console.log('[Blaze] No wallet connected');
                        return;
                    }
                    
                    // Check if user needs approval first (using the updated state)
                    if (blockchainData.blaze.userNeedsApproval) {
                        console.log('[Blaze] Needs approval - calling approve transaction');
                        await sendApprovalTransaction(address);
                        return;
                    }
                    
                    // Proceed to spend LP tokens (Blaze logic)
                    const lpBalance = parseFloat(blockchainData.blaze.userLpBalanceFormatted);
                    const lpNeeded = parseFloat(blockchainData.blaze.priceFormatted);
                    
                    if (lpBalance < lpNeeded) {
                        console.log('[Blaze] Insufficient LP balance');
                        console.log(`Need ${lpNeeded.toFixed(4)} LP but only have ${lpBalance.toFixed(4)} LP`);
                        return;
                    }
                    
                    console.log('[Blaze] Sending buy transaction...');
                    await sendBuyTransaction(address);
                    
                } catch (error) {
                    console.error('[Blaze] Error:', error);
                }
            };
            
            
            // --- REST OF ORIGINAL FUNCTIONS ---
            
            async function openGlazeFrame() {
                console.log('[Blockchain] Starting transaction...');
                
                try {
                    if (!FarcasterSDK) throw new Error("SDK not initialized.");
                    
                    console.log('[Blockchain] Fetching transaction data...');
                    
                    const address = blockchainData.userAddress; 
                    
                    if (!address) {
                        console.log('Transaction failed: Please connect your wallet first'); 
                        return;
                    }
                    
                    const txDataResponse = await fetch(`${API_BASE_URL}/api/transaction?player=${address}`, {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' },
                        mode: 'cors'
                    });
                    
                    if (!txDataResponse.ok) {
                        const errorText = await txDataResponse.text();
                        console.error('[Blockchain] Transaction API error:', errorText);
                        throw new Error(`Failed to get transaction data: ${txDataResponse.status}`);
                    }
                    
                    const txData = await txDataResponse.json();
                    console.log('[Blockchain] Transaction data received:', txData);
                    
                    const provider = await FarcasterSDK.wallet.getEthereumProvider();
                    
                    if (!provider) {
                        throw new Error('Wallet provider not available');
                    }
                    
                    console.log('[Blockchain] Sending transaction...');
                    
                    const txParams = [{
                        from: address, 
                        to: txData.params.to,
                        data: txData.params.data,
                        value: txData.params.value, 
                    }];

                    const txHash = await sendTxWithRetry(provider, txParams);
                    
                    console.log('[Blockchain] Transaction sent:', txHash);
                    
                    console.log('Transaction submitted! Refreshing game state...'); 
                    
                    setTimeout(() => {
                        console.log('[Blockchain] Refreshing after transaction...');
                        fetchGameState(blockchainData.userAddress);
                    }, 3000);
                    
                } catch (error) {
                    console.error('[Blockchain] Transaction error:', error);
                    console.log(`Transaction failed: ${error.message}`); 
                }
            }
            
            function handleGlazeClick() {
                console.log('[Blockchain] Glaze button clicked');
                openGlazeFrame();
            }

            
            async function sendBuyTransaction(address) {
                try {
                    console.log('[Blaze] Fetching buy transaction data...');
                    
                    const buyResponse = await fetch(`${API_BASE_URL}/api/blaze-transaction?player=${address}`, {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' },
                        mode: 'cors'
                    });
                    
                    if (!buyResponse.ok) {
                        throw new Error(`Failed to get buy transaction data: ${buyResponse.status}`);
                    }
                    
                    const txData = await buyResponse.json();
                    console.log('[Blaze] Buy transaction data received:', txData);
                    
                    const provider = await FarcasterSDK.wallet.getEthereumProvider();
                    
                    if (!provider) {
                        throw new Error('Wallet provider not available');
                    }
                    
                    console.log('[Blaze] Sending buy transaction...');
                    
                    const txParams = [{
                        from: address,
                        to: txData.params.to,
                        data: txData.params.data,
                        value: txData.params.value || '0x0',
                    }];
                    
                    const txHash = await sendTxWithRetry(provider, txParams);
                    
                    console.log('[Blaze] Buy transaction sent:', txHash);
                    console.log('Buy transaction submitted! You received ETH.');
                    
                    setTimeout(() => {
                        console.log('[Blaze] Refreshing after buy...');
                        fetchGameState(blockchainData.userAddress);
                    }, 3000);
                    
                } catch (error) {
                    console.error('[Blaze] Buy transaction error:', error);
                    console.log(`Buy transaction failed: ${error.message}`);
                }
            }
            
            function updateUI() {
                console.log('[Blockchain] Updating UI');
                
                const userIsMiner = blockchainData.userAddress && 
                                   blockchainData.currentMiner && 
                                   blockchainData.userAddress.toLowerCase() === blockchainData.currentMiner.toLowerCase();
                
               let kingGlazerDisplay;

                if (userIsMiner) {
                    kingGlazerDisplay = 'You';
                } else if (blockchainData.currentMinerUsername) {
                    kingGlazerDisplay = `@${blockchainData.currentMinerUsername}`;
                } else if (blockchainData.currentMiner && blockchainData.currentMiner !== '0x0000000000000000000000000000000000000000') {
                    const address = blockchainData.currentMiner;
                    kingGlazerDisplay = `${address.slice(0, 6)}...${address.slice(-4)}`;
                } else {
                    kingGlazerDisplay = 'None';
                }
                dom.glazery.kingStatus.textContent = kingGlazerDisplay;

                dom.glazery.cps.textContent = blockchainData.claimableDonutsFormatted ? formatNumber(blockchainData.claimableDonutsFormatted) : '0.00';
                dom.glazery.baked.textContent = formatTime(blockchainData.timeAsMiner || 0);
                
                dom.glazery.glazePrice.textContent = `${parseFloat(blockchainData.priceInEth || 0).toFixed(6)} ETH`;
                
                dom.glazery.availableBalance.textContent = `${parseFloat(blockchainData.userEthBalanceFormatted || 0).toFixed(4)} ETH available`;
                
                if (dom.glazery.blazeAvailableBalance) {
                     dom.glazery.blazeAvailableBalance.textContent = `${parseFloat(blockchainData.blaze.userLpBalanceFormatted || 0).toFixed(4)} LP available`;
                }
                
                if (dom.glazery.blazeClaimAmount && blockchainData.blaze.wethAccumulatedFormatted) {
                    const claimEth = parseFloat(blockchainData.blaze.wethAccumulatedFormatted);
                    dom.glazery.blazeClaimAmount.textContent = `${claimEth.toFixed(6)} ETH`;
                }
                
                if (dom.glazery.glazeDpsDisplay) {
                     dom.glazery.glazeDpsDisplay.textContent = parseFloat(blockchainData.currentDpsFormatted || 0).toFixed(2);
                }

                dom.glazery.donutBalance.textContent = `üç© ${formatNumber(blockchainData.userDonutBalanceFormatted || 0)}`;
                dom.glazery.totalSupply.textContent = `üç© ${formatNumber(blockchainData.totalDonutSupplyFormatted || 0)}`;
                dom.glazery.currentDps.textContent = parseFloat(blockchainData.currentDpsFormatted || 0).toFixed(2);
                
                dom.glazery.actionButton.textContent = 'Glaze';
                
                if (dom.modalInfo.totalSupply) {
                    dom.modalInfo.totalSupply.textContent = `üç© ${formatNumber(blockchainData.totalDonutSupplyFormatted || 0)}`;
                    dom.modalInfo.nextHalving.textContent = formatTime(blockchainData.secondsUntilHalving || 0);
                    
                    const minerDisplay = blockchainData.currentMiner 
                        ? `${blockchainData.currentMiner.slice(0, 6)}...${blockchainData.currentMiner.slice(-4)}`
                        : 'None';
                    dom.modalInfo.currentMiner.textContent = minerDisplay;
                }
            }

            function toggleView() {
                playSoundEffect('crunch');
                state.ui.isGlazeView = !state.ui.isGlazeView;

                if (state.ui.isGlazeView) {
                    dom.glazery.glazeContainer.classList.remove('hidden');
                    dom.glazery.blazeContainer.classList.add('hidden');
                    dom.glazery.toggleButton.textContent = 'üßä'; 
                } else {
                    dom.glazery.glazeContainer.classList.add('hidden');
                    dom.glazery.blazeContainer.classList.remove('hidden');
                    dom.glazery.toggleButton.textContent = 'üî•'; 
                }
            }
            // --- REST OF NON-BLOCKCHAIN JS FUNCTIONS ---
            
            // ... (functions like initAudio, playSoundEffect, toggleSfx, toggleMusic, toggleDarkMode, 
            // showInfoModal, hideInfoModal, and 3D functions are omitted for brevity here but remain in your file) ...

            // Start everything
            setTimeout(initThreeJS, 0);
            animate();
            init();
        });
    </script>
</body>
</html>
